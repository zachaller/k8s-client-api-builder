# Hydration template for WebService
# Demonstrates: variable substitution, conditionals, and resource references

resources:
  # Generate a Deployment
  - apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: $(.metadata.name)
      namespace: $(.metadata.namespace)
      labels:
        app: $(.metadata.name)
    spec:
      replicas: $(.spec.replicas)
      selector:
        matchLabels:
          app: $(.metadata.name)
      template:
        metadata:
          labels:
            app: $(.metadata.name)
        spec:
          containers:
          - name: app
            image: $(.spec.image)
            ports:
            - containerPort: $(.spec.port)

  # Generate a Service
  - apiVersion: v1
    kind: Service
    metadata:
      name: $(.metadata.name)
      namespace: $(.metadata.namespace)
      labels:
        app: $(.metadata.name)
    spec:
      type: ClusterIP
      selector:
        app: $(.metadata.name)
      ports:
      - name: http
        port: $(.spec.port)
        targetPort: $(.spec.port)
  
  # Conditionally generate an Ingress (demonstrates resource references)
  - "$if(.spec.enableIngress):":
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: $(.metadata.name)
        namespace: $(.metadata.namespace)
      spec:
        rules:
        - host: $(.spec.domain)
          http:
            paths:
            - path: /
              pathType: Prefix
              backend:
                service:
                  # Resource reference: dynamically get Service name
                  name: $(resource("v1", "Service", .metadata.name).metadata.name)
                  port:
                    # Resource reference: dynamically get Service port
                    number: $(resource("v1", "Service", .metadata.name).spec.ports[0].port)
  
  # ConfigMap with resource references
  - apiVersion: v1
    kind: ConfigMap
    metadata:
      name: $(.metadata.name + "-config")
      namespace: $(.metadata.namespace)
    data:
      SERVICE_NAME: $(resource("v1", "Service", .metadata.name).metadata.name)
      SERVICE_PORT: $(resource("v1", "Service", .metadata.name).spec.ports[0].port)
      SERVICE_URL: $(.metadata.name + ":" + resource("v1", "Service", .metadata.name).spec.ports[0].port)
