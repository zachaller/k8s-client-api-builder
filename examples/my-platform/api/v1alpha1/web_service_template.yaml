# Hydration template for WebService
# This template defines how a WebService instance expands into Kubernetes resources

resources:
  # Generate a Deployment
  - apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: $(.metadata.name)
      namespace: $(.metadata.namespace)
      labels:
        app: $(.metadata.name)
        managed-by: webservice
    spec:
      replicas: $(.spec.replicas)
      selector:
        matchLabels:
          app: $(.metadata.name)
      template:
        metadata:
          labels:
            app: $(.metadata.name)
        spec:
          containers:
          - name: app
            image: $(.spec.image)
            ports:
            - containerPort: $(.spec.port)
              protocol: TCP
          $if(.spec.enableHA):
            affinity:
              podAntiAffinity:
                preferredDuringSchedulingIgnoredDuringExecution:
                - weight: 100
                  podAffinityTerm:
                    labelSelector:
                      matchLabels:
                        app: $(.metadata.name)
                    topologyKey: kubernetes.io/hostname

  # Generate a Service
  - apiVersion: v1
    kind: Service
    metadata:
      name: $(.metadata.name)
      namespace: $(.metadata.namespace)
      labels:
        app: $(.metadata.name)
    spec:
      type: ClusterIP
      selector:
        app: $(.metadata.name)
      ports:
      - name: http
        port: $(.spec.port)
        targetPort: $(.spec.port)
        protocol: TCP
